<!-- Loading Screen -->
<div [ngClass]="{ hidden: !loading }" class="loading-container">
  <img src="/assets/loading.gif" alt="Loading..." class="loading-gif" />
</div>

<!-- Main Content Container -->
<div [ngClass]="{ visible: !loading }" class="main-content">
  <!-- Top Bar with Filter Button and Results Count -->
  <div class="top-bar">
    <button class="filter-toggle-btn" (click)="toggleFilters()">
      <img src="/assets/filter-icon.svg" alt="Filters" />
      <span>Refine Results</span>
    </button>
    
    <!-- <div class="result-count">
      Showing {{ itemCount }} {{ itemCount === 1 ? 'pet' : 'pets' }} 
    </div> -->
  </div>

  <!-- Filter Sidebar -->
  <div class="filter-sidebar" [ngClass]="{ 'open': isFilterOpen }">
    <div class="filter-content">
      <button class="close-filters" (click)="toggleFilters()">Ã—</button>
      <h2>Filters</h2>
      
      <!-- Filter Groups -->
      <!-- 1. Animal Filter -->
      <div class="filter-group">
        <label>Animal Type</label>
        <button mat-button [matMenuTriggerFor]="animalMenu" [ngClass]="{ filtered: filters.animal !== 'Any' }">
          {{ filters.animal }}
        </button>
        <mat-menu #animalMenu="matMenu">
          <button mat-menu-item (click)="setFilter('animal', 'Any')">Any</button>
          <button mat-menu-item (click)="setFilter('animal', 'Dog')">Dog</button>
          <button mat-menu-item (click)="setFilter('animal', 'Cat')">Cat</button>
          <button mat-menu-item (click)="setFilter('animal', 'Bird')">Bird</button>
          <button mat-menu-item (click)="setFilter('animal', 'Fish')">Fish</button>
          <button mat-menu-item (click)="setFilter('animal', 'Reptile')">Reptile</button>
          <button mat-menu-item (click)="setFilter('animal', 'Small Mammal')">Small Mammal</button>
          <button mat-menu-item (click)="setFilter('animal', 'Other')">Other</button>
        </mat-menu>
      </div>

      <!-- 2. Sex Filter -->
      <div class="filter-group">
        <label>Sex</label>
        <button mat-button [matMenuTriggerFor]="sexMenu" [ngClass]="{ filtered: filters.sex !== 'Any' }">
          {{ filters.sex }}
        </button>
        <mat-menu #sexMenu="matMenu">
          <button mat-menu-item (click)="setFilter('sex', 'Any')">Any</button>
          <button mat-menu-item (click)="setFilter('sex', 'Male')">Male</button>
          <button mat-menu-item (click)="setFilter('sex', 'Female')">Female</button>
        </mat-menu>
      </div>

      <!-- 3. Age Filter -->
      <div class="filter-group">
        <label>Age</label>
        <button mat-button [matMenuTriggerFor]="ageMenu" [ngClass]="{ filtered: filters.age !== 'Any' }">
          {{ filters.age }}
        </button>
        <mat-menu #ageMenu="matMenu">
          <button mat-menu-item (click)="setFilter('age', 'Any')">Any</button>
          <button mat-menu-item (click)="setFilter('age', 'Very Young')">Very Young (&lt;1)</button>
          <button mat-menu-item (click)="setFilter('age', 'Young')">Young (1-2)</button>
          <button mat-menu-item (click)="setFilter('age', 'Adult')">Adult (3-8)</button>
          <button mat-menu-item (click)="setFilter('age', 'Senior')">Senior (8+)</button>
        </mat-menu>
      </div>

      <!-- 4. Price Filter -->
      <div class="filter-group">
        <label>Price</label>
        <button mat-button [matMenuTriggerFor]="priceMenu" [ngClass]="{ filtered: filters.price !== 'Any' }">
          {{ filters.price }}
        </button>
        <mat-menu #priceMenu="matMenu">
          <button mat-menu-item (click)="setFilter('price', 'Any')">Any</button>
          <button mat-menu-item (click)="setFilter('price', 'Low')">Low (&lt;$500)</button>
          <button mat-menu-item (click)="setFilter('price', 'Medium')">Medium ($500-$1000)</button>
          <button mat-menu-item (click)="setFilter('price', 'High')">High (&gt;$1000)</button>
        </mat-menu>
      </div>

      <!-- 5. Location Filter -->
      <div class="filter-group">
        <label>Location</label>
        <button mat-button [matMenuTriggerFor]="locationMenu" [ngClass]="{ filtered: filters.location !== 'Any' }">
          {{ filters.location }}
        </button>
        <mat-menu #locationMenu="matMenu">
          <button mat-menu-item (click)="setFilter('location', 'Any')">Any</button>
          <button mat-menu-item (click)="setFilter('location', 'New York')">New York</button>
          <button mat-menu-item (click)="setFilter('location', 'Los Angeles')">Los Angeles</button>
          <button mat-menu-item (click)="setFilter('location', 'Chicago')">Chicago</button>
          <button mat-menu-item (click)="setFilter('location', 'Houston')">Houston</button>
          <button mat-menu-item (click)="setFilter('location', 'Other')">Other</button>
        </mat-menu>
      </div>

      <!-- Favorites Toggle Button -->
      <button *ngIf="isBuyer && favorites && favorites.length > 0" 
              mat-mini-fab 
              class="button" 
              (click)="toggleFavoriteFilter()">
        <ng-container *ngIf="favoriteFilter; else showFavorites">
          Show All Pets
        </ng-container>
        <ng-template #showFavorites>
          Show Favorites
          <img class="favorite-icon" src="/assets/favorite-star-active.svg" alt="Favorite Icon" />
        </ng-template>
      </button>
    </div>
  </div>

  <!-- Filter Overlay -->
  <div class="filter-overlay" [ngClass]="{ 'open': isFilterOpen }" (click)="toggleFilters()"></div>
  
  <!-- Pet Cards Grid -->
  <div class="cards">
    <div class="pet-card-container">
      <ng-container *ngFor="let item of items">
        <!-- Pet Card -->
        <div *ngIf="
          (filters.animal === 'Any' || filters.animal === this.getAnimalType(item.animal)) &&
          (filters.sex === 'Any' || item.sex.toLowerCase() === filters.sex.toLowerCase()) &&
          (filters.age === 'Any' ||
            (filters.age === 'Very Young' && getAge(item.birthdate) < 1) ||
            (filters.age === 'Young' && getAge(item.birthdate) >= 1 && getAge(item.birthdate) < 3) ||
            (filters.age === 'Adult' && getAge(item.birthdate) >= 3 && getAge(item.birthdate) < 8) ||
            (filters.age === 'Senior' && getAge(item.birthdate) > 8)) &&
          (filters.price === 'Any' ||
            (filters.price === 'Low' && item.price < 500) ||
            (filters.price === 'Medium' && item.price >= 500 && item.price <= 1000) ||
            (filters.price === 'High' && item.price > 1000)) &&
          (filters.location === 'Any' ||
            (filters.location === 'Other' &&
              !['New York', 'Los Angeles', 'Chicago', 'Houston'].includes(item.location)) ||
            item.location === filters.location)"
          mat-card
          class="pet-card"
          (click)="navigateToPetDesktop($event, item._id)"
          [ngClass]="{ 'expanded': expandedCards[item.name] }">
          
          <!-- Pet Card Content -->
          <div class="pet-image-background" [style.background-image]="'url(' + item.pictures[0] + ')'">
            <!-- Favorite Button -->
            <button *ngIf="isBuyer" class="petcard-favorite-button" (click)="toggleFavorite($event, item)">
              <img class="favorite-icon" 
                   [src]="item.isFavorite ? '/assets/favorite-star-active.svg' : '/assets/favorite-star-inactive.svg'" 
                   alt="Favorite Icon" />
            </button>

            <!-- Pet Info Card -->
            <div class="pet-info-card">
              <!-- Displayed Info -->
              <div class="displayed-info">
                <div class="info-text">
                  <h2 class="pet-name">{{ item.name }}</h2>
                  <p class="pet-age">
                    {{ item.sex | titlecase }},
                    {{ formatAge(getAge(item.birthdate)) }} old
                  </p>
                </div>
                <div class="button-group">
                  <button class="pet-page-button" (click)="navigateToPetMobile(item._id)">
                    Pet Page
                  </button>
                  <button class="show-hidden-button" (click)="toggleCard(item.name)">
                    {{ expandedCards[item.name] ? 'Hide Info' : 'Show Info' }}
                    <img class="expand arrow" 
                         [ngClass]="{'rotated': expandedCards[item.name]}" 
                         src="/assets/drop-down-arrow.svg" 
                         alt="expand-arrow" />
                  </button>
                </div>
              </div>

              <!-- Hidden Info -->
              <div class="hidden-info-container">
                <div class="hidden-info">
                  <div class="info-group">
                    <p class="pet-status-tag">Status:</p>
                    <p class="pet-status">{{ item.status }}</p>
                  </div>
                  <div class="info-group">
                    <p class="pet-breed-tag">Breed:</p>
                    <p class="pet-breed">{{ item.breed }}</p>
                  </div>
                  <div class="info-group">
                    <p class="pet-price-tag">Price:</p>
                    <p class="pet-price">{{ item.price | currency : "USD" : "symbol" : "1.0-0" }}</p>
                  </div>
                  <div class="info-group">
                    <p class="pet-location-tag">Location:</p>
                    <p class="pet-location">{{ item.location }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>
